# =============================================================================
# Docker Compose - Sistema de Mejora de Imágenes
# =============================================================================
# Uso:
#   docker-compose up -d              # Iniciar todos los servicios
#   docker-compose up -d --build      # Reconstruir e iniciar
#   docker-compose logs -f api        # Ver logs del API
#   docker-compose down               # Detener servicios
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # MongoDB - Base de datos
  # ---------------------------------------------------------------------------
  mongodb:
    image: mongo:7.0
    container_name: image_enhancer_mongodb
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_USER:-admin}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD:-admin123secure}
      MONGO_INITDB_DATABASE: ${MONGO_DB:-image_enhancer}
    ports:
      - "${MONGO_PORT:-27017}:27017"
    volumes:
      - mongodb_data:/data/db
      - ./mongo-init.js:/docker-entrypoint-initdb.d/mongo-init.js:ro
    networks:
      ImagesNet:
        ipv4_address: ${MONGODB_IP:-192.168.86.10}
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ---------------------------------------------------------------------------
  # API - Servicio de mejora de imágenes con Real-ESRGAN
  # ---------------------------------------------------------------------------
  api:
    build:
      context: ./API
      dockerfile: Dockerfile
    container_name: image_enhancer_api
    restart: unless-stopped
    environment:
      # MongoDB
      MONGO_HOST: ${MONGODB_IP:-192.168.86.10}
      MONGO_PORT: ${MONGO_PORT:-27017}
      MONGO_DB: ${MONGO_DB:-image_enhancer}
      MONGO_USER: ${MONGO_USER:-app_user}
      MONGO_PASSWORD: ${MONGO_PASSWORD:-app_password_secure}
      # API
      API_HOST: ${API_HOST:-0.0.0.0}
      API_PORT: ${API_PORT:-8888}
      API_DEBUG: ${API_DEBUG:-false}
      # JWT
      JWT_SECRET_KEY: ${JWT_SECRET_KEY:-your-super-secret-jwt-key-change-in-production}
      JWT_ACCESS_TOKEN_EXPIRE_MINUTES: ${JWT_ACCESS_TOKEN_EXPIRE_MINUTES:-30}
      JWT_REFRESH_TOKEN_EXPIRE_DAYS: ${JWT_REFRESH_TOKEN_EXPIRE_DAYS:-7}
      # GPU
      USE_GPU: ${USE_GPU:-TRUE}
      # Real-ESRGAN
      DEFAULT_SCALE: ${DEFAULT_SCALE:-4}
      TILE_SIZE: ${TILE_SIZE:-512}
      TILE_PAD: ${TILE_PAD:-10}
      # NVIDIA GPU Support
      NVIDIA_VISIBLE_DEVICES: all
      NVIDIA_DRIVER_CAPABILITIES: compute,utility
    ports:
      - "${API_PORT:-8888}:8888"
    volumes:
      - api_models:/app/models
      - ./image_history:/image_history
    networks:
      ImagesNet:
        ipv4_address: ${API_IP:-192.168.86.20}
    depends_on:
      mongodb:
        condition: service_healthy
    # ---------------------------------------------------------------------------
    # Configuración GPU NVIDIA
    # ---------------------------------------------------------------------------
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8888/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ---------------------------------------------------------------------------
  # Frontend - Aplicación React
  # ---------------------------------------------------------------------------
  front:
    image: nginx:alpine
    container_name: image_enhancer_front
    restart: unless-stopped
    ports:
      - "80:80"
    volumes:
      - ./front/build:/usr/share/nginx/html:ro
      - ./front/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      ImagesNet:
        ipv4_address: ${FRONT_IP:-192.168.86.30}
    depends_on:
      - api
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3

# =============================================================================
# Volúmenes persistentes
# =============================================================================
volumes:
  mongodb_data:
    driver: local
  api_models:
    driver: local

# =============================================================================
# Redes
# =============================================================================
networks:
  ImagesNet:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: ${NETWORK_SUBNET:-192.168.86.0/24}
          gateway: ${NETWORK_GATEWAY:-192.168.86.1}
